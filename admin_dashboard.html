<!DOCTYPE html>
<html lang="en">
<head>
    <script>
    // Only allow access if admin is logged in
    if (!sessionStorage.getItem('admin_logged_in')) {
        window.location.href = 'index.html';
    }
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin Dashboard - Online Voting System</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            padding: 20px;
            background-color: #f8f9fa;
        }
        .box {
            background: white;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 0 10px rgb(0 0 0 / 0.1);
        }
        .box-header {
            margin-bottom: 15px;
        }
        .table thead th {
            background-color: #007bff;
            color: white;
        }
        .btn-delete {
            color: #dc3545;
            cursor: pointer;
        }
        .btn-delete:hover {
            color: #a71d2a;
        }
        .chart-container {
            height: 300px;
            margin-bottom: 30px;
        }
        /* Topbar: match voter dashboard */
        .topbar {
            background:#007bff;
            color:#000;
            font-weight:700;
            border-radius:10px;
            margin-bottom:30px;
            min-height:64px;
        }
    .topbar a { color:#000 !important; font-weight:700; padding:8px 10px; border-radius:6px; display:inline-block; }
    .topbar a:hover { background:rgba(0,0,0,0.08); }
    .topbar a.active { background:rgba(0,0,0,0.2); }
    </style>
</head>
<body>

        <!-- Custom Top Bar -->
            <div class="d-flex align-items-center justify-content-between px-4 py-2 topbar shadow-sm">
                <div class="d-flex align-items-center">
                    <nav>
                        <a href="admin_dashboard.html" class="mx-2" style="text-decoration:none;">Dashboard</a>
                        <a href="users.html" class="mx-2" style="text-decoration:none;">Users</a>
                        <a href="candidates.html" class="mx-2" style="text-decoration:none;">Candidates</a>
                        <a href="events.html" class="mx-2" style="text-decoration:none;">Events</a>
                    </nav>
                </div>
                <div class="d-flex align-items-center">
                    <div class="dropdown">
                        <button class="btn btn-link d-flex align-items-center dropdown-toggle" type="button" id="adminProfileDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="border-radius: 20px; color:#000; font-weight:700;">
                            <i class="fa fa-user" style="margin-right:8px;"></i>
                            <span>Admin</span>
                        </button>
                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="adminProfileDropdown">
                            <a class="dropdown-item" href="#" id="logout-btn">Logout</a>
                        </div>
                    </div>
                </div>
            </div>

    <div class="container-fluid">
        <h1 class="mb-4">Admin Dashboard</h1>

        <!-- Only Vote Tally Section on Dashboard -->
        <div class="box">
            
            <div id="vote-tally-container" class="row"></div>
        </div>

        <!-- Winners by Event -->
        <div class="box">
            <div class="box-header">
                <h4 class="mb-3">Winners by Event</h4>
                <small class="text-muted">Shows winners for events that have ended. Ties list all top candidates.</small>
            </div>
            <div id="winners-container" class="row"></div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const voteTallyContainer = document.getElementById('vote-tally-container');
    const logoutBtn = document.getElementById('logout-btn');
    const winnersContainer = document.getElementById('winners-container');

        // Highlight current page in topbar
        (function highlightActiveLink(){
            try {
                var current = location.pathname.split('/').pop();
                document.querySelectorAll('.topbar nav a').forEach(function(a){
                    var href = a.getAttribute('href');
                    if (href === current) {
                        a.classList.add('active');
                        a.setAttribute('aria-current', 'page');
                    }
                });
            } catch(e) { /* noop */ }
        })();

    // Fetch candidates and render vote tally charts by position
        async function fetchVoteTally() {
            try {
                const res = await fetch('get_candidates.php');
                const candidates = await res.json();

                voteTallyContainer.innerHTML = '';
                const positions = [...new Set(candidates.map(c => c.position))];
                positions.forEach(position => {
                    const candidatesForPosition = candidates.filter(c => c.position === position);
                    const labels = candidatesForPosition.map(c => c.name);
                    const data = candidatesForPosition.map(c => c.votes);

                    const col = document.createElement('div');
                    col.className = 'col-md-6 chart-container';
                    col.innerHTML = `
                        <h5>${position} Results</h5>
                        <canvas id="chart-${position.replace(/\s/g, '-')}" style="height: 250px;"></canvas>
                    `;
                    voteTallyContainer.appendChild(col);

                    const ctx = col.querySelector('canvas').getContext('2d');
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Votes',
                                data: data,
                                backgroundColor: 'rgba(54, 162, 235, 0.7)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    precision: 0,
                                    min: 0,
                                    max: 100,
                                    title: {
                                        display: true,
                                        text: 'Votes'
                                    }
                                }
                            }
                        }
                    });
                });
            } catch (error) {
                console.error('Error fetching vote tally:', error);
            }
        }

        // Compute and render winners for ended events
        async function renderWinnersByEvent() {
            try {
                const [eventsRes, candidatesRes] = await Promise.all([
                    fetch('get_events.php'),
                    fetch('get_candidates.php')
                ]);
                const events = await eventsRes.json();
                const candidates = await candidatesRes.json();

                // Determine ended events
                const now = new Date();
                const endedEvents = events.filter(e => new Date(e.end_time) < now);

                // Group candidates by event and then by position
                const byEvent = new Map();
                candidates.forEach(c => {
                    const eventId = c.event_id;
                    if (!byEvent.has(eventId)) byEvent.set(eventId, []);
                    byEvent.get(eventId).push(c);
                });

                winnersContainer.innerHTML = '';
                if (endedEvents.length === 0) {
                    const empty = document.createElement('div');
                    empty.className = 'col-12 text-muted';
                    empty.textContent = 'No events have ended yet.';
                    winnersContainer.appendChild(empty);
                    return;
                }

                endedEvents.forEach(evt => {
                    const evCands = byEvent.get(evt.id) || [];
                    if (evCands.length === 0) return; // nothing to show

                    // group by position
                    const byPos = new Map();
                    evCands.forEach(c => {
                        const key = c.position || 'General';
                        if (!byPos.has(key)) byPos.set(key, []);
                        byPos.get(key).push(c);
                    });

                    const col = document.createElement('div');
                    col.className = 'col-md-6';
                    const card = document.createElement('div');
                    card.className = 'box';
                    const title = document.createElement('h5');
                    title.innerHTML = `${evt.title} <small class="text-muted" style="font-weight:400;">(ended ${new Date(evt.end_time).toLocaleString()})</small>`;
                    card.appendChild(title);

                    byPos.forEach((list, pos) => {
                        // Find max votes
                        const maxVotes = list.reduce((m, c) => Math.max(m, c.votes || 0), 0);
                        const winners = list.filter(c => (c.votes || 0) === maxVotes);
                        const hasVotes = list.some(c => (c.votes || 0) > 0);

                        const sec = document.createElement('div');
                        sec.className = 'mb-3';
                        const h = document.createElement('div');
                        h.style.fontWeight = '600';
                        h.textContent = pos;
                        sec.appendChild(h);

                        const p = document.createElement('div');
                        if (!hasVotes) {
                            p.className = 'text-muted';
                            p.textContent = 'No votes cast.';
                        } else if (winners.length === 1) {
                            p.innerHTML = `<span class="badge badge-success mr-2">Winner</span> ${winners[0].name} <span class="text-muted">(${maxVotes} votes)</span>`;
                        } else {
                            const names = winners.map(w => w.name).join(', ');
                            p.innerHTML = `<span class="badge badge-warning mr-2">Tie</span> ${names} <span class="text-muted">(${maxVotes} votes)</span>`;
                        }
                        sec.appendChild(p);
                        card.appendChild(sec);
                    });

                    col.appendChild(card);
                    winnersContainer.appendChild(col);
                });
            } catch (err) {
                console.error('Error rendering winners:', err);
            }
        }

        // Logout button handler (works for both old and new topbar)
        $(document).on('click', '#logout-btn', async function(e) {
            e.preventDefault();
            await fetch('logout.php');
            sessionStorage.removeItem('admin_logged_in');
            window.location.href = 'index.html';
        });

    // Initial load
    fetchVoteTally();
    renderWinnersByEvent();
    </script>
</body>
</html>